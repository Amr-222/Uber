@{
    ViewData["Title"] = "Driver Dashboard";
}

<h2>Driver Dashboard</h2>
<p>Waiting for ride requests...</p>

<div id="rideRequests"></div>
<div id="connectionStatus" style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
    <strong>Connection Status:</strong> <span id="statusText">Connecting...</span>
</div>

<!-- Use CDN for SignalR client library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
<script>
    let connection;
    let isConnected = false;

    // Initialize SignalR connection
    async function initializeConnection() {
        try {
            // Create connection to RideHub
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/rideHub", { 
                    skipNegotiation: true,
                    transport: signalR.HttpTransportType.WebSockets
                })
                .withAutomaticReconnect()
                .build();

            // Connection event handlers
            connection.onreconnecting(() => {
                updateStatus("Reconnecting...", "orange");
            });

            connection.onreconnected(() => {
                updateStatus("Connected", "green");
                isConnected = true;
            });

            connection.onclose(() => {
                updateStatus("Disconnected", "red");
                isConnected = false;
            });

            // When a ride request is received from RideController
            connection.on("ReceiveRideRequest", function (ride) {
                console.log("Received ride request:", ride);
                displayRideRequest(ride);
                
                // Show notification
                if (Notification.permission === "granted") {
                    new Notification("New Ride Request", {
                        body: "You have a new ride request!",
                        icon: "/favicon.ico"
                    });
                }
            });

            // Start connection
            await connection.start();
            updateStatus("Connected", "green");
            isConnected = true;
            console.log("SignalR Connected. Connection ID:", connection.connectionId);

            // Join driver-specific group - this is crucial for receiving ride requests
            await joinDriverGroup();

        } catch (err) {
            console.error("SignalR Connection Error:", err);
            updateStatus("Connection Failed: " + err.message, "red");
        }
    }

    // Function to join driver-specific group
    async function joinDriverGroup() {
        try {
            // Get the current user's ID from the page or authentication context
            // For now, we'll use a placeholder - in production, this should come from the server
            const driverId = await getCurrentDriverId();
            if (driverId) {
                await connection.invoke("JoinDriverGroup", driverId);
                console.log("Joined driver group:", driverId);
                updateStatus("Connected and joined driver group", "green");
            } else {
                console.warn("Could not determine driver ID");
                updateStatus("Connected but driver ID not found", "orange");
            }
        } catch (err) {
            console.error("Error joining driver group:", err);
        }
    }

    // Function to get current driver ID - this should be implemented based on your auth system
    async function getCurrentDriverId() {
        try {
            const response = await fetch('/Driver/GetCurrentDriverId');
            if (response.ok) {
                const data = await response.json();
                return data.driverId;
            } else {
                console.error('Failed to get driver ID:', response.status);
                return null;
            }
        } catch (err) {
            console.error('Error getting driver ID:', err);
            return null;
        }
    }

    function updateStatus(message, color) {
        const statusText = document.getElementById("statusText");
        statusText.textContent = message;
        statusText.style.color = color;
    }

    function displayRideRequest(ride) {
        const container = document.getElementById("rideRequests");
        
        // Clear previous requests
        container.innerHTML = "";

        const rideDiv = document.createElement("div");
        rideDiv.className = "ride-request";
        rideDiv.style.cssText = "border: 2px solid #007bff; border-radius: 8px; padding: 20px; margin: 15px; background-color: #f8f9fa; box-shadow: 0 2px 4px rgba(0,0,0,0.1);";
        
        rideDiv.innerHTML = `
            <h4 style="color: #007bff; margin-bottom: 15px;">🚗 New Ride Request</h4>
            <div style="margin-bottom: 15px;">
                <p><strong>Pickup Location:</strong> ${ride.startLat.toFixed(6)}, ${ride.startLng.toFixed(6)}</p>
                <p><strong>Destination:</strong> ${ride.endLat.toFixed(6)}, ${ride.endLng.toFixed(6)}</p>
                <p><strong>Ride ID:</strong> ${ride.rideId}</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="acceptRide('${ride.rideId}', '${ride.rideGroup}')" 
                        style="background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    ✅ Accept Ride
                </button>
                <button onclick="rejectRide('${ride.rideId}', '${ride.rideGroup}')" 
                        style="background-color: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    ❌ Reject Ride
                </button>
            </div>
        `;
        
        container.appendChild(rideDiv);
    }

    // Function to accept ride
    async function acceptRide(rideId, rideGroup) {
        try {
            const response = await fetch(`/Ride/DriverAccept`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: parseInt(rideId),
                    rideGroup: rideGroup
                })
            });

            if (response.ok) {
                document.getElementById("rideRequests").innerHTML = "<div style='color: green; padding: 20px; text-align: center;'><h3>✅ Ride Accepted!</h3><p>Redirecting to ride details...</p></div>";
                
                // Redirect to ride details page after a short delay
                setTimeout(() => {
                    window.location.href = `/Ride/RideDetails/${rideId}`;
                }, 2000);
            } else {
                const errorData = await response.json();
                alert("Error accepting ride: " + (errorData.message || "Unknown error"));
            }
        } catch (err) {
            console.error("Error:", err);
            alert("Error accepting ride. Please try again.");
        }
    }

    // Function to reject ride
    async function rejectRide(rideId, rideGroup) {
        try {
            const response = await fetch(`/Ride/DriverReject`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: parseInt(rideId),
                    rideGroup: rideGroup
                })
            });

            if (response.ok) {
                document.getElementById("rideRequests").innerHTML = "<div style='color: orange; padding: 20px; text-align: center;'><h3>⚠️ Ride Rejected</h3><p>You have rejected the ride request.</p></div>";
                
                // Clear the ride request after rejecting
                setTimeout(() => {
                    document.getElementById("rideRequests").innerHTML = "<p>Waiting for new ride requests...</p>";
                }, 3000);
            } else {
                const errorData = await response.json();
                alert("Error rejecting ride: " + (errorData.message || "Unknown error"));
            }
        } catch (err) {
            console.error("Error:", err);
            alert("Error rejecting ride. Please try again.");
        }
    }

    // Request notification permission
    if (Notification.permission === "default") {
        Notification.requestPermission();
    }

    // Initialize connection when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeConnection();
        startHeartbeat(); // Start heartbeat when page loads
    });

    // Function to set driver as inactive
    async function setDriverInactive() {
        try {
            const response = await fetch('/Driver/MakeUserInactive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                console.log('Driver status set to inactive');
            } else {
                console.error('Failed to set driver as inactive');
            }
        } catch (err) {
            console.error('Error setting driver as inactive:', err);
        }
    }

    // Function to set driver as active (for heartbeat)
    async function setDriverActive() {
        try {
            const response = await fetch('/Driver/MakeUserActive', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                console.log('Driver status set to active');
            } else {
                console.error('Failed to set driver as active');
            }
        } catch (err) {
            console.error('Error setting driver as active:', err);
        }
    }


    // Event listeners for page unload
    window.addEventListener('beforeunload', function(e) {
        // Set driver as inactive when leaving the page
        setDriverInactive();
    });

    window.addEventListener('unload', function(e) {
        // Set driver as inactive when leaving the page
        setDriverInactive();
    });

    // Event listener for page visibility change (when user switches tabs or minimizes browser)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // Page is hidden (user switched tabs or minimized browser)
            setDriverInactive();
        } else {
            // Page is visible again (user returned to the page)
            setDriverActive();
        }
    });

    // Event listener for page focus/blur (when user switches between applications)
    window.addEventListener('blur', function() {
        // User switched to another application
        setDriverInactive();
    });

    window.addEventListener('focus', function() {
        // User returned to the application
        setDriverActive();
    });

    // Event listener for browser navigation (back/forward buttons)
    window.addEventListener('popstate', function() {
        // User navigated away using browser navigation
        setDriverInactive();
    });

    // Event listener for beforeunload with confirmation dialog
    window.addEventListener('beforeunload', function(e) {
        // Show confirmation dialog and set driver as inactive
        setDriverInactive();
        e.preventDefault();
        e.returnValue = '';
    });

    // Event listener for page hide (when closing tab/window)
    window.addEventListener('pagehide', function() {
        // User is closing the tab or window
        setDriverInactive();
    });

    // Event listener for page show (when returning to the page)
    window.addEventListener('pageshow', function() {
        // User returned to the page
        if (!document.hidden) {
            setDriverActive();
            startHeartbeat();
        }
    });

    // Event listeners for online/offline status
    window.addEventListener('online', function() {
        // Internet connection restored
        console.log('Internet connection restored');
        // Reconnect SignalR if needed
        if (connection && !isConnected) {
            initializeConnection();
        }
    });

    window.addEventListener('offline', function() {
        // Internet connection lost
        console.log('Internet connection lost');
        // Set driver as inactive when offline
        setDriverInactive();
    });

    // User activity monitoring to detect idle state
    let userActivityTimeout;
    const IDLE_TIMEOUT = 5 * 60 * 1000; // 5 minutes

    function resetUserActivityTimer() {
        clearTimeout(userActivityTimeout);
        userActivityTimeout = setTimeout(() => {
            // User has been idle for 5 minutes, set as inactive
            console.log('User idle for 5 minutes, setting driver as inactive');
            setDriverInactive();
        }, IDLE_TIMEOUT);
    }

    // Reset timer on user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
        document.addEventListener(event, resetUserActivityTimer, true);
    });

    // Initialize user activity timer
    resetUserActivityTimer();

    // Device sleep/wake detection
    let wasPageVisible = true;
    
    function checkDeviceSleep() {
        if (wasPageVisible && document.hidden) {
            // Device might be going to sleep
            console.log('Device might be going to sleep');
            setDriverInactive();
        }
        wasPageVisible = !document.hidden;
    }

    // Check for device sleep every second
    setInterval(checkDeviceSleep, 1000);

    // Cleanup function to be called when leaving the page
    function cleanup() {
        stopHeartbeat();
        clearTimeout(userActivityTimeout);
        setDriverInactive();
    }

    // Call cleanup when page is unloaded
    window.addEventListener('unload', cleanup);

    // Add a method to manually set driver status (for debugging/testing)
    window.setDriverStatus = function(active) {
        if (active) {
            setDriverActive();
        } else {
            setDriverInactive();
        }
    };

    // Add a method to get current driver status (for debugging/testing)
    window.getDriverStatus = async function() {
        try {
            const response = await fetch('/Driver/GetCurrentDriverId');
            if (response.ok) {
                const data = await response.json();
                console.log('Current driver ID:', data.driverId);
                return data.driverId;
            }
        } catch (err) {
            console.error('Error getting driver status:', err);
        }
    };

    // Add a method to test the driver status functionality
    window.testDriverStatus = function() {
        console.log('Testing driver status functionality...');
        setDriverActive();
        setTimeout(() => {
            setDriverInactive();
            setTimeout(() => {
                setDriverActive();
            }, 1000);
        }, 1000);
    };

    // Heartbeat mechanism to keep driver active while on the page
    let heartbeatInterval;
    
    function startHeartbeat() {
        // Send heartbeat every 30 seconds to keep driver active
        heartbeatInterval = setInterval(async () => {
            if (!document.hidden && navigator.onLine) {
                try {
                    await setDriverActive();
                } catch (err) {
                    console.error('Heartbeat error:', err);
                }
            }
        }, 30000); // 30 seconds
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
            heartbeatInterval = null;
        }
    }

    // Start heartbeat when page becomes visible
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopHeartbeat();
            setDriverInactive();
        } else {
            startHeartbeat();
            setDriverActive();
        }
    });

    // Test function to simulate receiving a ride request (for debugging)
    window.testRideRequest = function() {
        const testRide = {
            rideId: 123,
            rideGroup: "ride-123",
            startLat: 40.7128,
            startLng: -74.0060,
            endLat: 40.7589,
            endLng: -73.9851
        };
        displayRideRequest(testRide);
    };
</script>

<!-- Debug section -->
<div style="margin-top: 30px; padding: 20px; background-color: #f0f0f0; border-radius: 5px;">
    <h4>Debug Tools:</h4>
    <button onclick="window.testRideRequest()" style="padding: 8px 16px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Test Ride Request
    </button>
    <button onclick="console.log('Connection:', connection)" style="padding: 8px 16px; margin: 5px; background-color: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Log Connection
    </button>
    <button onclick="testSignalRConnection()" style="padding: 8px 16px; margin: 5px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Test SignalR
    </button>
    <button onclick="testDriverGroup()" style="padding: 8px 16px; margin: 5px; background-color: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Test Driver Group
    </button>
    <button onclick="window.testDriverStatus()" style="padding: 8px 16px; margin: 5px; background-color: #ffc107; color: black; border: none; border-radius: 3px; cursor: pointer;">
        Test Driver Status
    </button>
    <button onclick="window.setDriverStatus(true)" style="padding: 8px 16px; margin: 5px; background-color: #17a2b8; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Set Active
    </button>
    <button onclick="window.setDriverStatus(false)" style="padding: 8px 16px; margin: 5px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
        Set Inactive
    </button>
</div>

<script>
    // Test function to simulate receiving a ride request (for debugging)
    window.testRideRequest = function() {
        const testRide = {
            rideId: 123,
            rideGroup: "ride-123",
            startLat: 40.7128,
            startLng: -74.0060,
            endLat: 40.7589,
            endLng: -73.9851
        };
        displayRideRequest(testRide);
    };

    // Test SignalR connection
    async function testSignalRConnection() {
        if (!connection || !isConnected) {
            alert("SignalR not connected!");
            return;
        }
        
        try {
            const result = await connection.invoke("TestConnection");
            console.log("SignalR test result:", result);
            alert("SignalR connection test successful!");
        } catch (err) {
            console.error("SignalR test error:", err);
            alert("SignalR test failed: " + err.message);
        }
    }

    // Test driver group functionality
    async function testDriverGroup() {
        if (!connection || !isConnected) {
            alert("SignalR not connected!");
            return;
        }
        
        try {
            const driverId = await getCurrentDriverId();
            if (driverId) {
                await connection.invoke("JoinDriverGroup", driverId);
                alert(`Successfully joined driver group: driver-${driverId}`);
            } else {
                alert("Could not get driver ID!");
            }
        } catch (err) {
            console.error("Driver group test error:", err);
            alert("Driver group test failed: " + err.message);
        }
    }
</script>
